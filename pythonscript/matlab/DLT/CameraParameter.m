% 2018/12/11 窪田 真汐
% カメラパラメータLの算出
% カメラが2台の場合に対応

clc; close all; imtool close all; clear; % 初期化

% キャリブレーションマーカ位置の入力
X0(:,:) = [ 1.2, 5.5, 0.053; ... % 1段目（高さ0.053m）
            1.2, 4.5, 0.053; ...
            1.2, 3.5, 0.053; ...
            1.2, 2.5, 0.053; ...
            1.2, 1.5, 0.053; ...
            1.2, 0.5, 0.053; ...
            1.2, 0, 0.053; ...
            0.6, 0, 0.053; ...
            0.6, 0.5, 0.053; ...
            0.6, 1.5, 0.053; ...
            0.6, 2.5, 0.053; ...
            0.6, 3.5, 0.053; ...
            0.6, 4.5, 0.053; ...
            0.6, 5.5, 0.053; ...
            0, 5.5, 0.053; ...
            0, 4.5, 0.053; ...
            0, 3.5, 0.053; ...
            0, 2.5, 0.053; ...
            0, 1.5, 0.053; ...
            0, 0.5, 0.053; ...
            0, 0, 0.053; ...
            1.2, 5.5, 0.653; ... % 2段目（高さ0.653m）
            1.2, 4.5, 0.653; ...
            1.2, 3.5, 0.653; ...
            1.2, 2.5, 0.653; ...
            1.2, 1.5, 0.653; ...
            1.2, 0.5, 0.653; ...
            1.2, 0, 0.653; ...
            0.6, 0, 0.653; ...
            0.6, 0.5, 0.653; ...
            0.6, 1.5, 0.653; ...
            0.6, 2.5, 0.653; ...
            0.6, 3.5, 0.653; ...
            0.6, 4.5, 0.653; ...
            0.6, 5.5, 0.653; ...
            0, 5.5, 0.653; ...
            0, 4.5, 0.653; ...
            0, 3.5, 0.653; ...
            0, 2.5, 0.653; ...
            0, 1.5, 0.653; ...
            0, 0.5, 0.653; ...
            0, 0, 0.653; ...
            1.2, 5.5, 1.453; ... % 3段目（高さ1.453m）
            1.2, 4.5, 1.453; ...
            1.2, 3.5, 1.453; ...
            1.2, 2.5, 1.453; ...
            1.2, 1.5, 1.453; ...
            1.2, 0.5, 1.453; ...
            1.2, 0, 1.453; ...
            0.6, 0, 1.453; ...
            0.6, 0.5, 1.453; ...
            0.6, 1.5, 1.453; ...
            0.6, 2.5, 1.453; ...
            0.6, 3.5, 1.453; ...
            0.6, 4.5, 1.453; ...
            0.6, 5.5, 1.453; ...
            0, 5.5, 1.453; ...
            0, 4.5, 1.453; ...
            0, 3.5, 1.453; ...
            0, 2.5, 1.453; ...
            0, 1.5, 1.453; ...
            0, 0.5, 1.453; ...
            0, 0, 1.453];

        
N = length(X0(:,1)); % キャリブレーションマーカの数
        
% キャリブレーションマーカのカメラ座標の読み込み
u0 = zeros(N,2);
v0 = zeros(N,2);

temp1 = csvread('キャリブレーション左横0.053.csv');
temp2 = csvread('キャリブレーション左横0.653.csv');
temp3 = csvread('キャリブレーション左横1.453.csv');

u0(:,1) = [ temp1(:,1); ...
            temp2(:,1); ...
            temp3(:,1)];

v0(:,1) = [ temp1(:,2); ...
            temp2(:,2); ...
            temp3(:,2)];
                  
temp1 = csvread('キャリブレーション左前0.053.csv');
temp2 = csvread('キャリブレーション左前0.653.csv');
temp3 = csvread('キャリブレーション左前1.453.csv'); 

u0(:,2) = [ temp1(:,1); ...
            temp2(:,1); ...
            temp3(:,1)];

v0(:,2) = [ temp1(:,2); ...
            temp2(:,2); ...
            temp3(:,2)];

% カメラパラメータの計算
W = zeros(2*N,11,2);
WT = zeros(11,2*N,2);
uv0 = zeros(2*N,2);
L = zeros(11,2); 

for i = 1:2
    for j = 1:N
        W(2*j-1,:,i) = [X0(j,1), X0(j,2), X0(j,3), 1, 0, 0, 0, 0, ...
                        -u0(j,i)*X0(j,1), -u0(j,i)*X0(j,2), -u0(j,i)*X0(j,3)];           
        W(2*j,:,i) = [0, 0, 0, 0, X0(j,1), X0(j,2), X0(j,3), 1, ...
                      -v0(j,i)*X0(j,1), -v0(j,i)*X0(j,2), -v0(j,i)*X0(j,3)];                      
        uv0(2*j-1,i) = u0(j,i);
        uv0(2*j,i) = v0(j,i);
    end

    WT(:,:,i) = W(:,:,i).';
    L(:,i) = (WT(:,:,i)*W(:,:,i)) \ (WT(:,:,i)*uv0(:,i)); 
end
